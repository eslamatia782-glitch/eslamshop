<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ESLAM$HOP â€” Ù…ØªØ¬Ø± ÙØ§Ø®Ø±</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800;900&display=swap" rel="stylesheet"/>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
  import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword,
           sendPasswordResetEmail, signOut, onAuthStateChanged }
    from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
  import { getFirestore, collection, addDoc, getDocs, doc,
           updateDoc, deleteDoc, serverTimestamp }
    from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

  const firebaseConfig = {
    apiKey: 'AIzaSyCEASwcOh8U8jut9iG755t15dQlg4W3auk',
    authDomain: 'eslamshop-ea2b6.firebaseapp.com',
    projectId: 'eslamshop-ea2b6',
    storageBucket: 'eslamshop-ea2b6.firebasestorage.app',
    messagingSenderId: '695193798024',
    appId: '1:695193798024:web:adfb50b48bff00272a263d',
    measurementId: 'G-VJGYYNXJSL'
  };

  const app  = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  window.__shop = {
    auth, db,
    ADMIN_EMAIL  : 'admin@eslamshop.com',
    BACKEND_URL  : 'http://localhost:3001',          // â† Ø¹Ù†ÙˆØ§Ù† Backend Node.js
    COUPON_CODES : { 'ESLAM10': 10, 'ESLAM20': 20 },
    fns: { signInWithEmailAndPassword, createUserWithEmailAndPassword,
           sendPasswordResetEmail, signOut, onAuthStateChanged,
           collection, addDoc, getDocs, doc, updateDoc, deleteDoc, serverTimestamp }
  };
  window.dispatchEvent(new Event('firebaseReady'));
</script>

<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}

:root{
  --gold:#d4af37;--gold2:#f0d060;
  --dark:#0a0a0f;--dark2:#12121a;--dark3:#1a1a28;
  --glass:rgba(255,255,255,0.05);--glass2:rgba(255,255,255,0.1);
  --border:rgba(212,175,55,0.25);
  --text:#e8e0d0;--text2:#a09880;
  --danger:#ff4d6d;--success:#00d68f;
  --radius:16px;
}

body{font-family:'Tajawal',sans-serif;background:var(--dark);color:var(--text);min-height:100vh;overflow-x:hidden;
  background-image:radial-gradient(ellipse 80% 60% at 20% 10%,rgba(212,175,55,.07) 0%,transparent 60%),
                   radial-gradient(ellipse 60% 80% at 80% 90%,rgba(212,175,55,.04) 0%,transparent 60%)}

body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;opacity:.35;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E")}

::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:var(--dark2)}::-webkit-scrollbar-thumb{background:var(--gold);border-radius:4px}

@keyframes fadeUp{from{opacity:0;transform:translateY(28px)}to{opacity:1;transform:translateY(0)}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes shimmer{from{background-position:-200% 0}to{background-position:200% 0}}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.45}}
@keyframes slideRight{from{transform:translateX(110%);opacity:0}to{transform:translateX(0);opacity:1}}
@keyframes scaleIn{from{opacity:0;transform:scale(.92)}to{opacity:1;transform:scale(1)}}

.anim{animation:fadeUp .55s ease both}
.d1{animation-delay:.08s}.d2{animation-delay:.16s}.d3{animation-delay:.24s}.d4{animation-delay:.32s}

/* â”€â”€ GLASS â”€â”€ */
.glass{background:var(--glass);backdrop-filter:blur(22px);-webkit-backdrop-filter:blur(22px);border:1px solid var(--border);border-radius:var(--radius)}

/* â”€â”€ NAVBAR â”€â”€ */
#navbar{position:fixed;top:0;left:0;right:0;z-index:200;padding:14px 32px;
  display:flex;align-items:center;justify-content:space-between;
  background:rgba(10,10,15,.85);backdrop-filter:blur(24px);border-bottom:1px solid var(--border);
  animation:fadeIn .5s ease}

.nav-logo{font-size:1.55rem;font-weight:900;letter-spacing:3px;cursor:pointer;
  background:linear-gradient(135deg,var(--gold),var(--gold2),var(--gold));background-size:200% auto;
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:shimmer 3.5s linear infinite}

.nav-actions{display:flex;gap:10px;align-items:center}

/* â”€â”€ BUTTONS â”€â”€ */
.btn{display:inline-flex;align-items:center;gap:7px;padding:10px 22px;border-radius:50px;
  font-family:'Tajawal',sans-serif;font-size:.88rem;font-weight:700;cursor:pointer;border:none;
  transition:all .28s ease;position:relative;overflow:hidden;white-space:nowrap}
.btn-gold{background:linear-gradient(135deg,var(--gold),var(--gold2));color:#000}
.btn-gold:hover{transform:translateY(-2px);box-shadow:0 8px 28px rgba(212,175,55,.45)}
.btn-ghost{background:var(--glass);border:1px solid var(--border);color:var(--text)}
.btn-ghost:hover{background:var(--glass2);border-color:var(--gold)}
.btn-danger{background:var(--danger);color:#fff}
.btn-danger:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(255,77,109,.4)}
.btn-sm{padding:7px 15px;font-size:.78rem}
.btn:disabled{opacity:.45;cursor:not-allowed;transform:none!important}

/* â”€â”€ CART ICON â”€â”€ */
.cart-wrap{position:relative;cursor:pointer;width:42px;height:42px;display:flex;align-items:center;
  justify-content:center;border-radius:50%;border:1px solid var(--border);background:var(--glass);
  transition:all .28s;font-size:1.1rem}
.cart-wrap:hover{border-color:var(--gold);background:var(--glass2)}
.cart-badge{position:absolute;top:-4px;right:-4px;background:var(--gold);color:#000;
  width:19px;height:19px;border-radius:50%;font-size:.62rem;font-weight:900;
  display:flex;align-items:center;justify-content:center}

/* â”€â”€ PAGES â”€â”€ */
.page{display:none;min-height:100vh;padding-top:80px}
.page.active{display:block;animation:fadeIn .38s ease}

/* â”€â”€ SHOP PAGE â”€â”€ */
#page-shop{padding:100px 32px 60px}

.hero{text-align:center;margin-bottom:70px;padding:40px 0 0}
.hero-eyebrow{font-size:.82rem;letter-spacing:4px;text-transform:uppercase;color:var(--gold);
  margin-bottom:16px;font-weight:600;opacity:.85}
.hero-title{font-size:clamp(2.6rem,6vw,5rem);font-weight:900;line-height:1.08;
  background:linear-gradient(150deg,#fff 0%,var(--gold) 45%,var(--gold2) 100%);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:18px}
.hero-sub{color:var(--text2);font-size:1.05rem;max-width:480px;margin:0 auto;line-height:1.7}

/* â”€â”€ PRODUCTS GRID â”€â”€ */
.products-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(285px,1fr));gap:24px;max-width:1200px;margin:0 auto}

.product-card{padding:0;overflow:hidden;position:relative;transition:all .38s ease;cursor:default}
.product-card:hover{transform:translateY(-9px);box-shadow:0 24px 60px rgba(212,175,55,.14);border-color:rgba(212,175,55,.55)}

.product-img{width:100%;height:210px;background:linear-gradient(135deg,var(--dark3),var(--dark2));
  display:flex;align-items:center;justify-content:center;font-size:4.5rem;
  position:relative;overflow:hidden}
.product-img::after{content:'';position:absolute;inset:0;background:linear-gradient(to bottom,transparent 60%,rgba(10,10,15,.6))}

.product-body{padding:20px}
.product-name{font-size:1.08rem;font-weight:800;margin-bottom:6px}
.product-desc{font-size:.83rem;color:var(--text2);margin-bottom:16px;line-height:1.55}
.product-footer{display:flex;align-items:center;justify-content:space-between;gap:12px}
.product-price{font-size:1.3rem;font-weight:900;color:var(--gold)}
.product-stock{font-size:.76rem;color:var(--text2);margin-top:3px}
.product-stock.low{color:#f0a500}.product-stock.out{color:var(--danger);font-weight:700}

.badge-out{position:absolute;top:14px;right:14px;z-index:2;background:var(--danger);
  color:#fff;padding:4px 12px;border-radius:20px;font-size:.72rem;font-weight:800}

/* â”€â”€ EMPTY / LOADER â”€â”€ */
.empty{text-align:center;padding:70px 20px;color:var(--text2)}
.empty-icon{font-size:3rem;margin-bottom:16px}
.empty-text{font-size:1rem}

/* â”€â”€ ADMIN PAGE â”€â”€ */
#page-admin{padding:100px 32px 60px;max-width:1100px;margin:0 auto}
.admin-hd{display:flex;align-items:center;justify-content:space-between;margin-bottom:40px;flex-wrap:wrap;gap:16px}
.admin-hd h1{font-size:2rem;font-weight:800}
.admin-hd h1 span{color:var(--gold)}

.admin-card{padding:28px;margin-bottom:36px}
.admin-card-title{font-size:1.1rem;font-weight:700;margin-bottom:22px}

.admin-table{width:100%;border-collapse:collapse}
.admin-table th,.admin-table td{padding:13px 15px;text-align:right;border-bottom:1px solid var(--border);font-size:.88rem}
.admin-table th{color:var(--gold);font-weight:700;background:rgba(212,175,55,.05)}
.admin-table tr:hover td{background:rgba(255,255,255,.02)}
.admin-table-wrap{overflow-x:auto;border-radius:var(--radius);border:1px solid var(--border)}

/* â”€â”€ MODALS â”€â”€ */
.overlay{display:none;position:fixed;inset:0;z-index:300;background:rgba(0,0,0,.78);
  backdrop-filter:blur(10px);align-items:center;justify-content:center;padding:20px}
.overlay.open{display:flex;animation:fadeIn .28s ease}

.modal{width:100%;max-width:500px;max-height:90vh;overflow-y:auto;padding:36px;
  position:relative;animation:scaleIn .35s ease}
.modal-close{position:absolute;top:14px;left:14px;width:32px;height:32px;border-radius:50%;
  background:var(--glass2);border:1px solid var(--border);cursor:pointer;color:var(--text2);
  display:flex;align-items:center;justify-content:center;font-size:1rem;transition:all .25s}
.modal-close:hover{color:var(--text);border-color:var(--gold)}
.modal-title{font-size:1.45rem;font-weight:800;margin-bottom:22px}

/* â”€â”€ AUTH MODAL INSIDE CHECKOUT â”€â”€ */
.auth-tabs-m{display:flex;gap:4px;margin-bottom:26px;background:rgba(255,255,255,.05);border-radius:12px;padding:4px}
.auth-tab-m{flex:1;padding:10px;text-align:center;border-radius:9px;cursor:pointer;
  font-weight:700;font-size:.88rem;transition:all .28s;color:var(--text2)}
.auth-tab-m.active{background:var(--gold);color:#000}

/* â”€â”€ FIELDS â”€â”€ */
.field{margin-bottom:18px}
.field label{display:block;font-size:.83rem;color:var(--text2);margin-bottom:7px;font-weight:600}
.field input,.field textarea{width:100%;padding:12px 15px;border-radius:12px;
  background:rgba(255,255,255,.05);border:1px solid var(--border);color:var(--text);
  font-family:'Tajawal',sans-serif;font-size:.93rem;transition:all .28s}
.field input:focus,.field textarea:focus{outline:none;border-color:var(--gold);
  background:rgba(255,255,255,.08);box-shadow:0 0 0 3px rgba(212,175,55,.1)}
.field input::placeholder,.field textarea::placeholder{color:var(--text2)}

.auth-foot{text-align:center;margin-top:16px;font-size:.83rem;color:var(--text2)}
.auth-foot span{color:var(--gold);cursor:pointer;font-weight:700}
.auth-foot span:hover{text-decoration:underline}

/* â”€â”€ CART ITEMS â”€â”€ */
.cart-item{display:flex;align-items:center;gap:14px;padding:14px;border-radius:12px;
  background:var(--glass);border:1px solid var(--border);margin-bottom:11px}
.ci-icon{width:48px;height:48px;border-radius:10px;background:var(--dark3);
  display:flex;align-items:center;justify-content:center;font-size:1.45rem;flex-shrink:0}
.ci-info{flex:1}
.ci-name{font-weight:700;font-size:.93rem}
.ci-price{color:var(--gold);font-size:.87rem;font-weight:600;margin-top:2px}
.qty-ctrl{display:flex;align-items:center;gap:7px}
.qty-btn{width:28px;height:28px;border-radius:8px;border:1px solid var(--border);
  background:var(--glass2);color:var(--text);cursor:pointer;font-size:1rem;
  display:flex;align-items:center;justify-content:center;transition:all .2s;flex-shrink:0}
.qty-btn:hover{border-color:var(--gold);color:var(--gold)}
.qty-num{font-weight:800;min-width:24px;text-align:center}

.divider{border:none;border-top:1px solid var(--border);margin:18px 0}
.coupon-row{display:flex;gap:10px;margin-bottom:14px}
.coupon-row input{flex:1;padding:10px 14px;border-radius:10px;background:var(--glass);
  border:1px solid var(--border);color:var(--text);font-family:'Tajawal',sans-serif;font-size:.88rem}
.coupon-row input:focus{outline:none;border-color:var(--gold)}
.discount-msg{color:var(--success);font-size:.83rem;margin-bottom:12px;display:none}
.cart-total-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
.cart-total-lbl{color:var(--text2);font-weight:600}
.cart-total-val{font-size:1.4rem;font-weight:900;color:var(--gold)}

/* â”€â”€ FORM GRID â”€â”€ */
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:15px}
@media(max-width:580px){.form-grid{grid-template-columns:1fr}}

/* â”€â”€ TOAST â”€â”€ */
#toasts{position:fixed;bottom:22px;right:22px;z-index:9999;display:flex;flex-direction:column;gap:9px}
.toast{padding:13px 19px;border-radius:12px;font-weight:700;font-size:.87rem;
  backdrop-filter:blur(20px);border:1px solid;max-width:320px;animation:slideRight .38s ease}
.toast.success{background:rgba(0,214,143,.14);border-color:rgba(0,214,143,.4);color:var(--success)}
.toast.error{background:rgba(255,77,109,.14);border-color:rgba(255,77,109,.4);color:var(--danger)}
.toast.info{background:rgba(212,175,55,.14);border-color:rgba(212,175,55,.4);color:var(--gold)}

/* â”€â”€ SPINNER â”€â”€ */
.spinner{width:19px;height:19px;border:2px solid rgba(255,255,255,.2);
  border-top-color:var(--gold);border-radius:50%;animation:spin .7s linear infinite}

/* â”€â”€ PAGE LOADER â”€â”€ */
#loader{position:fixed;inset:0;background:var(--dark);z-index:9999;
  display:flex;align-items:center;justify-content:center;flex-direction:column;gap:18px;transition:opacity .5s}
#loader .logo{font-size:2.4rem;font-weight:900;letter-spacing:4px;color:var(--gold);animation:pulse 1.6s ease infinite}

/* â”€â”€ CHECKOUT AUTH BANNER â”€â”€ */
.checkout-banner{background:linear-gradient(135deg,rgba(212,175,55,.12),rgba(212,175,55,.05));
  border:1px solid rgba(212,175,55,.3);border-radius:14px;padding:18px 20px;
  margin-bottom:20px;display:flex;align-items:center;gap:14px}
.checkout-banner-icon{font-size:1.8rem}
.checkout-banner-text{font-size:.88rem;color:var(--text2);line-height:1.6}
.checkout-banner-text strong{color:var(--gold);display:block;font-size:.95rem;margin-bottom:3px}

@media(max-width:768px){
  #navbar{padding:13px 18px}
  #page-shop{padding:90px 16px 50px}
  .products-grid{gap:16px}
  #page-admin{padding:90px 16px 50px}
  .modal{padding:26px 20px}
}
</style>
</head>
<body>

<!-- PAGE LOADER -->
<div id="loader"><div class="logo">ESLAM$HOP</div><div class="spinner"></div></div>

<!-- TOASTS -->
<div id="toasts"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â• NAVBAR â•â•â•â•â•â•â•â•â•â•â•â• -->
<nav id="navbar">
  <div class="nav-logo" onclick="goHome()">ESLAM$HOP</div>
  <div class="nav-actions" id="nav-actions"></div>
</nav>

<!-- â•â•â•â•â•â•â•â•â•â•â•â• SHOP PAGE (PUBLIC) â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="page-shop" class="page active">
  <div class="hero anim">
    <div class="hero-eyebrow">âœ¦ Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ø®ØªØ§Ø±Ø© Ø¨Ø¹Ù†Ø§ÙŠØ© âœ¦</div>
    <div class="hero-title">Ø§ÙƒØªØ´Ù Ø§Ù„Ø£ÙØ¶Ù„</div>
    <div class="hero-sub">Ù…Ù†ØªØ¬Ø§Øª Ø­ØµØ±ÙŠØ© Ø¨Ø¬ÙˆØ¯Ø© Ù„Ø§ Ù…Ø«ÙŠÙ„ Ù„Ù‡Ø§ â€” ØªØµÙØ­ Ø¨Ø­Ø±ÙŠØ©ØŒ ÙˆØ£Ø¶Ù Ù…Ø§ ØªØ­Ø¨</div>
  </div>
  <div class="products-grid" id="products-grid">
    <div class="empty" style="grid-column:1/-1"><div class="empty-icon">â³</div><div class="empty-text">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...</div></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â• ADMIN PAGE â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="page-admin" class="page">
  <div class="admin-hd anim">
    <h1>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… <span>Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©</span></h1>
    <button class="btn btn-gold btn-sm" onclick="openModal('modal-add-product')">+ Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</button>
  </div>
  <div class="admin-card glass anim d1">
    <div class="admin-card-title">ğŸ“¦ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>
    <div class="admin-table-wrap">
      <table class="admin-table">
        <thead><tr><th>Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
        <tbody id="admin-tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â• MODAL: CART â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="overlay" id="modal-cart">
  <div class="modal glass" style="max-width:560px">
    <div class="modal-close" onclick="closeModal('modal-cart')">âœ•</div>
    <div class="modal-title">ğŸ›’ Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</div>
    <div id="cart-items-list"></div>
    <hr class="divider"/>
    <div class="coupon-row">
      <input type="text" id="coupon-input" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ø®ØµÙ… (ESLAM10 Ø£Ùˆ ESLAM20)"/>
      <button class="btn btn-ghost btn-sm" onclick="applyCoupon()">ØªØ·Ø¨ÙŠÙ‚</button>
    </div>
    <div id="discount-msg" class="discount-msg"></div>
    <div class="cart-total-row">
      <span class="cart-total-lbl">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span>
      <span class="cart-total-val" id="cart-total-val">0 EGP</span>
    </div>
    <button class="btn btn-gold" style="width:100%;justify-content:center;font-size:1rem" onclick="proceedCheckout()">
      ğŸ’³ Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø´Ø±Ø§Ø¡
    </button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â• MODAL: AUTH AT CHECKOUT â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="overlay" id="modal-auth-checkout">
  <div class="modal glass" style="max-width:460px">
    <div class="modal-close" onclick="closeModal('modal-auth-checkout')">âœ•</div>

    <div class="checkout-banner">
      <div class="checkout-banner-icon">ğŸ”’</div>
      <div class="checkout-banner-text">
        <strong>Ø®Ø·ÙˆØ© Ø£Ø®ÙŠØ±Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø¯ÙØ¹</strong>
        Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ø£Ùˆ Ø£Ù†Ø´Ø¦ Ø­Ø³Ø§Ø¨Ø§Ù‹ Ù…Ø¬Ø§Ù†ÙŠØ§Ù‹ Ù„Ø¥ØªÙ…Ø§Ù… Ø·Ù„Ø¨Ùƒ â€” Ø³Ù„ØªÙƒ Ù…Ø­ÙÙˆØ¸Ø©!
      </div>
    </div>

    <div class="auth-tabs-m">
      <div class="auth-tab-m active" id="co-tab-login" onclick="switchCoTab('login')">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</div>
      <div class="auth-tab-m" id="co-tab-signup" onclick="switchCoTab('signup')">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</div>
    </div>

    <!-- Login form -->
    <div id="co-login">
      <div class="field"><label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label><input type="email" id="co-login-email" placeholder="example@email.com"/></div>
      <div class="field"><label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label><input type="password" id="co-login-pass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"/></div>
      <button class="btn btn-gold" style="width:100%;justify-content:center" id="btn-co-login" onclick="doCoLogin()">Ø¯Ø®ÙˆÙ„ ÙˆØ¥ØªÙ…Ø§Ù… Ø§Ù„Ø´Ø±Ø§Ø¡ ğŸ›ï¸</button>
      <div class="auth-foot"><span onclick="showForgotModal()">Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ</span></div>
    </div>

    <!-- Signup form -->
    <div id="co-signup" style="display:none">
      <div class="field"><label>Ø§Ù„Ø§Ø³Ù…</label><input type="text" id="co-signup-name" placeholder="Ø¥Ø³Ù„Ø§Ù… Ù…Ø­Ù…Ø¯"/></div>
      <div class="field"><label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label><input type="email" id="co-signup-email" placeholder="example@email.com"/></div>
      <div class="field"><label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label><input type="password" id="co-signup-pass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢ (6 Ø£Ø­Ø±Ù+)"/></div>
      <button class="btn btn-gold" style="width:100%;justify-content:center" id="btn-co-signup" onclick="doCoSignup()">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ ÙˆØ¥ØªÙ…Ø§Ù… Ø§Ù„Ø´Ø±Ø§Ø¡ ğŸ›ï¸</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â• MODAL: FORGOT PASSWORD â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="overlay" id="modal-forgot">
  <div class="modal glass" style="max-width:420px">
    <div class="modal-close" onclick="closeModal('modal-forgot')">âœ•</div>
    <div class="modal-title">ğŸ”‘ Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</div>
    <div class="field"><label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label><input type="email" id="forgot-email" placeholder="example@email.com"/></div>
    <button class="btn btn-gold" style="width:100%;justify-content:center" onclick="doForgot()">Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â• MODAL: ADD PRODUCT â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="overlay" id="modal-add-product">
  <div class="modal glass">
    <div class="modal-close" onclick="closeModal('modal-add-product')">âœ•</div>
    <div class="modal-title">â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</div>
    <div class="form-grid">
      <div class="field"><label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬*</label><input type="text" id="ap-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬"/></div>
      <div class="field"><label>Ø§Ù„Ø³Ø¹Ø± (EGP)*</label><input type="number" id="ap-price" placeholder="299"/></div>
      <div class="field" style="grid-column:span 2"><label>Ø§Ù„ÙˆØµÙ</label><textarea id="ap-desc" rows="2" placeholder="ÙˆØµÙ Ù‚ØµÙŠØ±..."></textarea></div>
      <div class="field"><label>Ø§Ù„ÙƒÙ…ÙŠØ©*</label><input type="number" id="ap-qty" placeholder="50"/></div>
      <div class="field"><label>Ø¥ÙŠÙ…ÙˆØ¬ÙŠ</label><input type="text" id="ap-icon" placeholder="ğŸ"/></div>
    </div>
    <button class="btn btn-gold" style="width:100%;justify-content:center;margin-top:16px" onclick="addProduct()">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â• MODAL: EDIT PRODUCT â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="overlay" id="modal-edit-product">
  <div class="modal glass">
    <div class="modal-close" onclick="closeModal('modal-edit-product')">âœ•</div>
    <div class="modal-title">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬</div>
    <input type="hidden" id="ep-id"/>
    <div class="field"><label>Ø§Ù„Ø§Ø³Ù…</label><input type="text" id="ep-name"/></div>
    <div class="form-grid">
      <div class="field"><label>Ø§Ù„Ø³Ø¹Ø±</label><input type="number" id="ep-price"/></div>
      <div class="field"><label>Ø§Ù„ÙƒÙ…ÙŠØ©</label><input type="number" id="ep-qty"/></div>
    </div>
    <div class="field"><label>Ø§Ù„ÙˆØµÙ</label><textarea id="ep-desc" rows="2"></textarea></div>
    <div class="field"><label>Ø¥ÙŠÙ…ÙˆØ¬ÙŠ</label><input type="text" id="ep-icon"/></div>
    <button class="btn btn-gold" style="width:100%;justify-content:center;margin-top:14px" onclick="saveEdit()">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â• MAIN SCRIPT â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
// â”€â”€â”€ STATE â”€â”€â”€
let currentUser = null, isAdmin = false;
let cart = [], products = [];
let couponDiscount = 0, couponApplied = '';
let pendingCheckout = false;   // flag: show checkout after login
let auth, db, fns, ADMIN_EMAIL, BACKEND_URL, COUPON_CODES;

// â”€â”€â”€ INIT â”€â”€â”€
window.addEventListener('firebaseReady', () => {
  ({ auth, db, ADMIN_EMAIL, BACKEND_URL, COUPON_CODES, fns } = window.__shop);

  // Load products immediately (public)
  loadProducts();

  fns.onAuthStateChanged(auth, user => {
    currentUser = user;
    isAdmin     = user?.email === ADMIN_EMAIL;
    renderNav();

    if (user) {
      // If user just logged in during checkout flow, proceed
      if (pendingCheckout) {
        pendingCheckout = false;
        closeModal('modal-auth-checkout');
        setTimeout(doStripeCheckout, 250);
      }
      // Admin â†’ show admin page
      if (isAdmin && !document.getElementById('page-admin').classList.contains('active')) {
        showPage('admin');
      }
    }
    hideLoader();
  });
});

function hideLoader(){
  const l=document.getElementById('loader');
  l.style.opacity='0';
  setTimeout(()=>l.style.display='none',500);
}

// â”€â”€â”€ NAV â”€â”€â”€
function renderNav(){
  const el = document.getElementById('nav-actions');
  const count = cart.reduce((s,i)=>s+i.qty,0);

  let html = '';
  if (currentUser) {
    if (!isAdmin) {
      html += `<div class="cart-wrap" onclick="openCart()">ğŸ›’${count>0?`<span class="cart-badge">${count}</span>`:''}</div>`;
    }
    if (isAdmin) {
      html += `<button class="btn btn-ghost btn-sm" onclick="showPage('shop')">Ø§Ù„Ù…ØªØ¬Ø±</button>`;
      html += `<button class="btn btn-ghost btn-sm" onclick="showPage('admin')">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</button>`;
    }
    html += `<button class="btn btn-ghost btn-sm" onclick="doLogout()">Ø®Ø±ÙˆØ¬</button>`;
  } else {
    // Not logged in â€“ show cart + login button
    html += `<div class="cart-wrap" onclick="openCart()">ğŸ›’${count>0?`<span class="cart-badge">${count}</span>`:''}</div>`;
    html += `<button class="btn btn-ghost btn-sm" onclick="openModal('modal-auth-checkout')">Ø¯Ø®ÙˆÙ„</button>`;
  }
  el.innerHTML = html;
}

function goHome(){ showPage('shop'); }
function showPage(name){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById('page-'+name).classList.add('active');
  if(name==='admin') renderAdminTable();
}

// â”€â”€â”€ PRODUCTS â”€â”€â”€
async function loadProducts(){
  try {
    const snap = await fns.getDocs(fns.collection(db,'products'));
    products = snap.docs.map(d=>({id:d.id,...d.data()}));
    renderProducts();
  } catch(e){ toast('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª','error'); }
}

function renderProducts(){
  const grid = document.getElementById('products-grid');
  if(!products.length){
    grid.innerHTML=`<div class="empty" style="grid-column:1/-1"><div class="empty-icon">ğŸ›ï¸</div><div class="empty-text">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ø¨Ø¹Ø¯</div></div>`;
    return;
  }
  grid.innerHTML = products.map((p,i)=>`
    <div class="product-card glass anim" style="animation-delay:${i*.07}s">
      ${p.qty<=0?'<div class="badge-out">Ù†ÙØ¯Øª Ø§Ù„ÙƒÙ…ÙŠØ©</div>':''}
      <div class="product-img">${p.icon||'ğŸ“¦'}</div>
      <div class="product-body">
        <div class="product-name">${p.name}</div>
        <div class="product-desc">${p.desc||''}</div>
        <div class="product-footer">
          <div>
            <div class="product-price">${Number(p.price).toLocaleString()} EGP</div>
            <div class="product-stock ${p.qty<=0?'out':p.qty<=5?'low':''}">
              ${p.qty<=0?'Ù†ÙØ¯Øª Ø§Ù„ÙƒÙ…ÙŠØ©':`Ù…ØªØ¨Ù‚ÙŠ: ${p.qty}`}
            </div>
          </div>
          ${p.qty>0?`<button class="btn btn-gold btn-sm" onclick="addToCart('${p.id}')">+ Ø³Ù„Ø©</button>`:''}
        </div>
      </div>
    </div>`).join('');
}

// â”€â”€â”€ CART â”€â”€â”€
function addToCart(id){
  const p = products.find(x=>x.id===id);
  if(!p||p.qty<=0) return toast('Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ØªØ§Ø­','error');
  const existing = cart.find(x=>x.id===id);
  if(existing&&existing.qty>=p.qty) return toast('Ù„Ø§ ØªØªÙˆÙØ± ÙƒÙ…ÙŠØ© ÙƒØ§ÙÙŠØ©','error');
  if(existing) existing.qty++;
  else cart.push({...p,qty:1});
  renderNav();
  toast(`ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© "${p.name}" âœ…`,'success');
}

function updateQty(id,delta){
  const item = cart.find(x=>x.id===id);
  if(!item) return;
  item.qty += delta;
  if(item.qty<=0) cart = cart.filter(x=>x.id!==id);
  renderCartModal();
  renderNav();
}

function openCart(){ renderCartModal(); openModal('modal-cart'); }

function renderCartModal(){
  const list = document.getElementById('cart-items-list');
  if(!cart.length){
    list.innerHTML=`<div class="empty"><div class="empty-icon">ğŸ›’</div><div class="empty-text">Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©</div></div>`;
    document.getElementById('cart-total-val').textContent='0 EGP';
    document.getElementById('discount-msg').style.display='none';
    return;
  }
  list.innerHTML = cart.map(item=>`
    <div class="cart-item">
      <div class="ci-icon">${item.icon||'ğŸ“¦'}</div>
      <div class="ci-info">
        <div class="ci-name">${item.name}</div>
        <div class="ci-price">${Number(item.price).toLocaleString()} EGP Ã— ${item.qty}</div>
      </div>
      <div class="qty-ctrl">
        <div class="qty-btn" onclick="updateQty('${item.id}',-1)">âˆ’</div>
        <span class="qty-num">${item.qty}</span>
        <div class="qty-btn" onclick="updateQty('${item.id}',1)">+</div>
      </div>
    </div>`).join('');

  const sub      = cart.reduce((s,i)=>s+i.price*i.qty,0);
  const discount = couponDiscount ? Math.round(sub*couponDiscount/100) : 0;
  const total    = sub - discount;

  const dm = document.getElementById('discount-msg');
  if(couponDiscount){ dm.style.display='block'; dm.textContent=`âœ… Ø®ØµÙ… ${couponDiscount}% Ø¨ÙƒÙˆØ¯ "${couponApplied}" â€” ÙˆÙÙ‘Ø±Øª ${discount.toLocaleString()} EGP`; }
  else { dm.style.display='none'; }

  document.getElementById('cart-total-val').textContent = total.toLocaleString()+' EGP';
}

function applyCoupon(){
  const code = document.getElementById('coupon-input').value.trim().toUpperCase();
  if(!code) return toast('Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø®ØµÙ…','error');
  if(COUPON_CODES[code]){ couponDiscount=COUPON_CODES[code]; couponApplied=code; renderCartModal(); toast(`Ø®ØµÙ… ${couponDiscount}% ÙØ¹Ù‘Ø§Ù„! ğŸ‰`,'success'); }
  else toast('Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­','error');
}

// â”€â”€â”€ CHECKOUT FLOW â”€â”€â”€
function proceedCheckout(){
  if(!cart.length) return toast('Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©','error');
  closeModal('modal-cart');

  if(currentUser){
    // Already logged in â†’ go straight to Stripe
    doStripeCheckout();
  } else {
    // Not logged in â†’ show auth modal
    pendingCheckout = true;
    openModal('modal-auth-checkout');
  }
}

async function doStripeCheckout(){
  if(!cart.length) return;
  toast('Ø¬Ø§Ø±Ù ØªØ­Ø¶ÙŠØ± Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¯ÙØ¹...','info');

  const sub      = cart.reduce((s,i)=>s+i.price*i.qty,0);
  const discount = couponDiscount ? Math.round(sub*couponDiscount/100) : 0;
  const total    = sub - discount;

  try {
    // â”€â”€ Call Node.js backend to create Stripe Checkout Session â”€â”€
    const res = await fetch(`${BACKEND_URL}/create-checkout-session`, {
      method : 'POST',
      headers: { 'Content-Type':'application/json' },
      body   : JSON.stringify({
        items   : cart.map(i=>({id:i.id,name:i.name,price:i.price,qty:i.qty,icon:i.icon})),
        coupon  : couponApplied||null,
        discount,
        userId  : currentUser.uid,
        userEmail: currentUser.email
      })
    });

    if(!res.ok) throw new Error(await res.text());
    const { url } = await res.json();

    // Save pending order to Firestore (status: pending)
    await fns.addDoc(fns.collection(db,'orders'),{
      userId   : currentUser.uid,
      userEmail: currentUser.email,
      items    : cart.map(i=>({id:i.id,name:i.name,price:i.price,qty:i.qty})),
      subtotal : sub, discount, total,
      coupon   : couponApplied||null,
      status   : 'pending',
      createdAt: fns.serverTimestamp()
    });

    // Redirect to Stripe Checkout
    window.location.href = url;

  } catch(e){
    console.error(e);
    toast('âŒ ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Backend. ØªØ£ÙƒØ¯ Ù…Ù† ØªØ´ØºÙŠÙ„ server.js','error');
    // Fallback: show confirmation locally
    showLocalConfirm(total);
  }
}

function showLocalConfirm(total){
  // Optimistic stock update locally if backend is offline
  cart.forEach(item=>{
    const p = products.find(x=>x.id===item.id);
    if(p) p.qty = Math.max(0, p.qty - item.qty);
  });
  cart=[];couponDiscount=0;couponApplied='';
  renderNav(); renderProducts();

  const ov = document.createElement('div');
  ov.className='overlay open';
  ov.innerHTML=`<div class="modal glass" style="text-align:center;max-width:400px">
    <div style="font-size:3rem;margin-bottom:14px">ğŸ‰</div>
    <div class="modal-title" style="text-align:center">ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨Ùƒ!</div>
    <p style="color:var(--text2);line-height:1.7;margin-bottom:22px">
      Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <strong style="color:var(--gold)">${total.toLocaleString()} EGP</strong><br/>
      <small style="font-size:.78rem;opacity:.7">Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ø´ØºÙ‘Ù„ <code>server.js</code></small>
    </p>
    <button class="btn btn-gold" style="width:100%;justify-content:center" onclick="this.closest('.overlay').remove()">Ø­Ø³Ù†Ø§Ù‹</button>
  </div>`;
  document.body.appendChild(ov);
}

// â”€â”€â”€ AUTH MODAL (checkout) â”€â”€â”€
function switchCoTab(tab){
  document.getElementById('co-tab-login').classList.toggle('active', tab==='login');
  document.getElementById('co-tab-signup').classList.toggle('active', tab==='signup');
  document.getElementById('co-login').style.display  = tab==='login'  ? 'block':'none';
  document.getElementById('co-signup').style.display = tab==='signup' ? 'block':'none';
}

async function doCoLogin(){
  const email = document.getElementById('co-login-email').value.trim();
  const pass  = document.getElementById('co-login-pass').value;
  if(!email||!pass) return toast('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§Ù…Ù„Ø©','error');
  const btn = document.getElementById('btn-co-login');
  setLoading(btn,true);
  try {
    await fns.signInWithEmailAndPassword(auth,email,pass);
    // onAuthStateChanged will handle pendingCheckout
    toast('Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ! âœ¨','success');
  } catch(e){ toast(authErr(e.code),'error'); }
  finally{ setLoading(btn,false); }
}

async function doCoSignup(){
  const name  = document.getElementById('co-signup-name').value.trim();
  const email = document.getElementById('co-signup-email').value.trim();
  const pass  = document.getElementById('co-signup-pass').value;
  if(!name||!email||!pass) return toast('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§Ù…Ù„Ø©','error');
  if(pass.length<6) return toast('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„','error');
  const btn = document.getElementById('btn-co-signup');
  setLoading(btn,true);
  try {
    await fns.createUserWithEmailAndPassword(auth,email,pass);
    toast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨! ğŸ‰','success');
  } catch(e){ toast(authErr(e.code),'error'); }
  finally{ setLoading(btn,false); }
}

async function doLogout(){
  await fns.signOut(auth);
  cart=[]; couponDiscount=0; couponApplied=''; pendingCheckout=false;
  showPage('shop');
  toast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬','info');
}

async function doForgot(){
  const email = document.getElementById('forgot-email').value.trim();
  if(!email) return toast('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ','error');
  try { await fns.sendPasswordResetEmail(auth,email); toast('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© âœ‰ï¸','success'); closeModal('modal-forgot'); }
  catch(e){ toast(authErr(e.code),'error'); }
}

function showForgotModal(){ closeModal('modal-auth-checkout'); openModal('modal-forgot'); }

// â”€â”€â”€ ADMIN â”€â”€â”€
function renderAdminTable(){
  const tbody = document.getElementById('admin-tbody');
  if(!products.length){ tbody.innerHTML='<tr><td colspan="4" style="text-align:center;padding:30px;color:var(--text2)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª</td></tr>'; return; }
  tbody.innerHTML = products.map(p=>`
    <tr>
      <td>${p.icon||'ğŸ“¦'} ${p.name}</td>
      <td>${Number(p.price).toLocaleString()} EGP</td>
      <td><span style="color:${p.qty<=0?'var(--danger)':p.qty<=5?'#f0a500':'var(--success)'};font-weight:800">${p.qty}</span></td>
      <td>
        <button class="btn btn-ghost btn-sm" style="margin-left:8px" onclick="showEditModal('${p.id}')">ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="btn btn-danger btn-sm" onclick="deleteProduct('${p.id}')">Ø­Ø°Ù</button>
      </td>
    </tr>`).join('');
}

async function addProduct(){
  const name=document.getElementById('ap-name').value.trim();
  const price=parseFloat(document.getElementById('ap-price').value);
  const desc=document.getElementById('ap-desc').value.trim();
  const qty=parseInt(document.getElementById('ap-qty').value);
  const icon=document.getElementById('ap-icon').value.trim()||'ğŸ“¦';
  if(!name||!price||isNaN(qty)) return toast('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©','error');
  try {
    const ref = await fns.addDoc(fns.collection(db,'products'),{name,price,desc,qty,icon,createdAt:new Date().toISOString()});
    products.push({id:ref.id,name,price,desc,qty,icon});
    closeModal('modal-add-product');
    ['ap-name','ap-price','ap-desc','ap-qty','ap-icon'].forEach(id=>document.getElementById(id).value='');
    renderAdminTable(); renderProducts();
    toast('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ âœ…','success');
  } catch(e){ toast('Ø®Ø·Ø£: '+e.message,'error'); }
}

function showEditModal(id){
  const p=products.find(x=>x.id===id);if(!p)return;
  document.getElementById('ep-id').value=id;
  document.getElementById('ep-name').value=p.name;
  document.getElementById('ep-price').value=p.price;
  document.getElementById('ep-qty').value=p.qty;
  document.getElementById('ep-desc').value=p.desc||'';
  document.getElementById('ep-icon').value=p.icon||'';
  openModal('modal-edit-product');
}

async function saveEdit(){
  const id=document.getElementById('ep-id').value;
  const name=document.getElementById('ep-name').value.trim();
  const price=parseFloat(document.getElementById('ep-price').value);
  const qty=parseInt(document.getElementById('ep-qty').value);
  const desc=document.getElementById('ep-desc').value.trim();
  const icon=document.getElementById('ep-icon').value.trim()||'ğŸ“¦';
  if(!name||!price||isNaN(qty)) return toast('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©','error');
  try {
    await fns.updateDoc(fns.doc(db,'products',id),{name,price,desc,qty,icon});
    const p=products.find(x=>x.id===id);
    if(p) Object.assign(p,{name,price,desc,qty,icon});
    closeModal('modal-edit-product'); renderAdminTable(); renderProducts();
    toast('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« âœ…','success');
  } catch(e){ toast('Ø®Ø·Ø£: '+e.message,'error'); }
}

async function deleteProduct(id){
  if(!confirm('ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°ÙØŸ')) return;
  try {
    await fns.deleteDoc(fns.doc(db,'products',id));
    products=products.filter(x=>x.id!==id);
    renderAdminTable(); renderProducts();
    toast('ØªÙ… Ø§Ù„Ø­Ø°Ù','info');
  } catch(e){ toast('Ø®Ø·Ø£: '+e.message,'error'); }
}

// â”€â”€â”€ MODALS â”€â”€â”€
function openModal(id){ document.getElementById(id).classList.add('open'); }
function closeModal(id){ document.getElementById(id).classList.remove('open'); }

document.querySelectorAll('.overlay').forEach(ov=>{
  ov.addEventListener('click',function(e){ if(e.target===this) this.classList.remove('open'); });
});

// â”€â”€â”€ UTILS â”€â”€â”€
function toast(msg,type='info',duration=3500){
  const c=document.getElementById('toasts');
  const el=document.createElement('div');
  el.className=`toast ${type}`; el.textContent=msg; c.appendChild(el);
  setTimeout(()=>{ el.style.opacity='0'; el.style.transform='translateX(110%)'; el.style.transition='.38s'; setTimeout(()=>el.remove(),400); },duration);
}

function setLoading(btn,loading){
  btn.disabled=loading;
  if(loading){ btn.dataset.orig=btn.innerHTML; btn.innerHTML='<div class="spinner"></div>'; }
  else btn.innerHTML=btn.dataset.orig||btn.innerHTML;
}

function authErr(code){
  return ({
    'auth/user-not-found':'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± Ù…Ø³Ø¬Ù„',
    'auth/wrong-password':'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©',
    'auth/invalid-credential':'Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©',
    'auth/email-already-in-use':'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„',
    'auth/weak-password':'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ© Ø¬Ø¯Ø§Ù‹',
    'auth/invalid-email':'ØµÙŠØºØ© Ø§Ù„Ø¨Ø±ÙŠØ¯ ØºÙŠØ± ØµØ­ÙŠØ­Ø©',
    'auth/too-many-requests':'Ù…Ø­Ø§ÙˆÙ„Ø§Øª ÙƒØ«ÙŠØ±Ø©ØŒ Ø§Ù†ØªØ¸Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹',
  }[code])||'Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹';
}

document.addEventListener('keydown',e=>{
  if(e.key==='Escape') document.querySelectorAll('.overlay.open').forEach(m=>m.classList.remove('open'));
});
</script>
</body>
</html>
